-- =================================================================
-- ==       !!! ОПАСНО !!! СБРОС ЗАПИСЕЙ НА СЕГОДНЯШНИЙ ДЕНЬ        ==
-- =================================================================
--
-- Назначение:
-- 1. Удаляет ВСЕ записи из таблицы `appointments` за СЕГОДНЯ.
-- 2. Делает ВСЕ слоты в `schedules` за СЕГОДНЯ снова доступными.
-- Полезно для многократного тестирования процесса записи.
--
-- Оборачиваем в транзакцию, чтобы обе операции выполнились успешно, либо ни одна.
-- psql -h localhost -p 5432 -U postgres -d el_queue -f scripts/reset_todays_appointments.sql
--

BEGIN;

-- Сначала находим ID всех слотов на сегодня, которые нужно будет обновить
WITH todays_schedules AS (
    SELECT schedule_id FROM schedules WHERE date = CURRENT_DATE
)
-- Удаляем записи, которые ссылаются на сегодняшние слоты
DELETE FROM appointments
WHERE schedule_id IN (SELECT schedule_id FROM todays_schedules);

-- Теперь делаем все сегодняшние слоты снова доступными
UPDATE schedules
SET is_available = true
WHERE date = CURRENT_DATE;

COMMIT;

-- Сообщение об успешном выполнении
SELECT 'Все записи на сегодня удалены, а слоты в расписании помечены как доступные.' as "Результат";